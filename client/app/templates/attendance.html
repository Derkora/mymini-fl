{% extends "layout.html" %}

{% block content %}
<h1>Absensi Live</h1>

<div class="card" style="text-align: center;">
    
    <div id="videoContainer" style="margin-bottom: 20px;">
        <video id="video" width="400" height="300" autoplay style="border: 1px solid #ccc; border-radius: 4px;"></video>
        <canvas id="canvas" width="400" height="300" style="display:none;"></canvas>
    </div>
    
    <button type="button" class="btn btn-start" id="btnStart" onclick="startAttendance()">Mulai Absensi Live</button>
    <button type="button" class="btn btn-warning" id="btnStop" onclick="stopAttendance()" style="display:none;">Hentikan Absensi</button>
    
    <div id="statusDisplay" style="margin-top: 20px; font-size: 1.2em; font-weight: bold; color: #333;">
        Menunggu...
    </div>

    <div id="resultDisplay" style="margin-top: 20px; min-height: 200px; display: flex; flex-direction: column; align-items: center;">
        </div>

</div>

<script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusDisplay = document.getElementById('statusDisplay');
    const resultDisplay = document.getElementById('resultDisplay');
    let attendanceInterval;
    let isRunning = false;
    const captureRate = 3000; // Kirim frame setiap 3 detik

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 400, height: 300 } });
            video.srcObject = stream;
            return true;
        } catch(err) {
            statusDisplay.innerHTML = '<span style="color: red;">Gagal akses kamera: ' + err + '</span>';
            return false;
        }
    }

    function stopCamera() {
        if(video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    function captureAndSend() {
        if (!isRunning) return;

        statusDisplay.innerText = "Mendeteksi wajah dan mengirim data...";
        
        const context = canvas.getContext('2d');
        // Pastikan dimensi video digunakan untuk menggambar
        context.drawImage(video, 0, 0, 400, 300); 
        
        canvas.toBlob(function(blob) {
            const formData = new FormData();
            formData.append('file', blob, 'live_frame.jpg');

            fetch('/attendance', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text()) 
            .then(html => {
                // Parse HTML result (kita asumsikan endpoint /attendance mengembalikan HTML result)
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Ambil elemen status dan message
                const statusBox = tempDiv.querySelector('.status-box');
                const h1Status = tempDiv.querySelector('h1');
                
                if (statusBox) {
                    const message = statusBox.querySelector('h3').textContent;
                    
                    // Coba ambil gambar bounding box dari details (jika ada)
                    const bbImg = statusBox.querySelector('img');
                    
                    let newContent = '';
                    let statusColor = 'orange';

                    if (h1Status && h1Status.style.color === 'green') {
                        statusColor = 'green';
                    } else if (h1Status && h1Status.style.color === 'red') {
                        statusColor = 'red';
                    }

                    statusDisplay.innerHTML = `<span style="color: ${statusColor};">${message}</span>`;
                    
                    // Update tampilan hasil
                    resultDisplay.innerHTML = '';
                    if (bbImg) {
                        resultDisplay.appendChild(bbImg);
                    }
                    
                    // Tampilkan detail hasil (nama, skor, dll)
                    const detailsList = statusBox.querySelector('ul');
                    if(detailsList) {
                         const detailsDiv = document.createElement('div');
                         detailsDiv.style.marginTop = '10px';
                         detailsDiv.innerHTML = '<strong>Detail Absensi Terakhir:</strong>';
                         detailsDiv.appendChild(detailsList);
                         resultDisplay.appendChild(detailsDiv);
                    }
                } else {
                    statusDisplay.innerText = "Respon server tidak valid.";
                }
            })
            .catch(err => {
                statusDisplay.innerHTML = `<span style="color: red;">Error saat mengirim frame: ${err}</span>`;
            });
        }, 'image/jpeg');
    }

    async function startAttendance() {
        if (isRunning) return;
        
        const cameraStarted = await startCamera();
        if (!cameraStarted) return;
        
        isRunning = true;
        document.getElementById('btnStart').style.display = 'none';
        document.getElementById('btnStop').style.display = 'inline-block';
        statusDisplay.innerText = "Absensi live dimulai (mengirim setiap 3 detik)...";
        resultDisplay.innerHTML = '';

        // Jeda sebentar agar kamera siap, lalu mulai interval
        setTimeout(() => {
            captureAndSend(); // Kirim frame pertama segera
            attendanceInterval = setInterval(captureAndSend, captureRate);
        }, 1000); 
    }

    function stopAttendance() {
        if (!isRunning) return;
        
        isRunning = false;
        clearInterval(attendanceInterval);
        stopCamera();
        
        document.getElementById('btnStart').style.display = 'inline-block';
        document.getElementById('btnStop').style.display = 'none';
        statusDisplay.innerText = "Absensi Live Dihentikan.";
        resultDisplay.innerHTML = '';
    }

    // Pastikan berhenti jika user navigasi
    window.addEventListener('beforeunload', stopAttendance);
</script>
{% endblock %}